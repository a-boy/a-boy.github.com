<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi 写真集</title>
    <style>
        /* --- 1. 基本和移动优先布局 --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            gap: 1rem;
        }
        h1 {
            color: #4CAF50; /* Pi Green */
            font-weight: 300;
        }

        /* --- 2. 控制区域 (输入和按钮) --- */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            width: 100%;
            max-width: 500px;
        }
        .controls label, .navigation-controls label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.25rem;
            display: block;
        }
        .controls input, .navigation-controls input {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            background-color: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
        }
        .controls .generate-btn {
            grid-column: 1 / -1;
            padding: 0.85rem;
            font-size: 1.1rem;
            font-weight: 600;
            background-color: #4CAF50;
            color: #121212;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .controls .generate-btn:hover {
            background-color: #5cdb60;
        }

        /* --- 3. 图像显示区域 --- */
        .viewer {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1 / 1;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        canvas {
            width: 100%;
            height: 100%;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #fff;
            display: none; /* 默认隐藏 */
        }
        .viewer.loading canvas {
            opacity: 0.2;
        }
        .viewer.loading .loader {
            display: block;
        }

        /* --- 4. 导航区域 (新) --- */
        .navigation-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 500px;
        }
        
        /* 帧数输入框和随机按钮 */
        .frame-input-group {
            display: flex;
            gap: 0.5rem;
        }
        .frame-input-group input[type="number"] {
            flex-grow: 1; /* 占据主要空间 */
        }
        .frame-input-group button {
            padding: 0 1.25rem;
            font-size: 1rem;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 8px;
            cursor: pointer;
        }

        /* 滚动条样式 */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            padding: 0; /* 覆盖 .controls input 样式 */
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }

        /* 禁用状态 */
        input:disabled, button:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
            border-color: #444;
        }
        input[type="range"]:disabled::-webkit-slider-thumb {
            background: #666;
        }
        input[type="range"]:disabled::-moz-range-thumb {
            background: #666;
        }

    </style>
</head>
<body>

    <h1>Pi 写真集 📷</h1>

    <div class="controls">
        <div>
            <label for="widthInput">宽度 (Width)</label>
            <input id="widthInput" type="number" value="64">
        </div>
        <div>
            <label for="heightInput">高度 (Height)</label>
            <input id="heightInput" type="number" value="64">
        </div>
        <button id="generateBtn" class="generate-btn">生成 / 重置</button>
    </div>

    <div id="viewer" class="viewer">
        <canvas id="piCanvas"></canvas>
        <div id="loader" class="loader">加载中...</div>
    </div>

    <div class="navigation-controls">
        <div>
            <label for="frameInput">帧 (Frame)</label>
            <div class="frame-input-group">
                <input id="frameInput" type="number" min="1" value="1" disabled>
                <button id="randomBtn" disabled>随机</button>
            </div>
        </div>
        <div>
            <label for="frameSlider">滚动条 (Slider)</label>
            <input id="frameSlider" type="range" min="1" max="10000" value="1" disabled>
        </div>
    </div>

    <script>
        // --- DOM 元素 ---
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');
        const generateBtn = document.getElementById('generateBtn');
        const frameInput = document.getElementById('frameInput');
        const randomBtn = document.getElementById('randomBtn');
        const frameSlider = document.getElementById('frameSlider');
        const canvas = document.getElementById('piCanvas');
        const ctx = canvas.getContext('2d');
        const viewer = document.getElementById('viewer');

        // --- 状态变量 ---
        let currentFrame = 1;
        let canvasWidth = 0;
        let canvasHeight = 0;
        let digitsPerFrame = 0;
        let isFetching = false;
        
        // --- API 设置 ---
        const API_BASE_URL = 'https://api.pi.delivery/v1/pi';
        const API_MAX_DIGITS_PER_REQUEST = 50000;

        // --- 事件监听 ---
        generateBtn.onclick = initializeGallery;
        randomBtn.onclick = goToRandomFrame;

        // 滚动条：oninput 在拖动时触发，onchange 在释放时触发
        // 我们在拖动时更新数字框，在释放时才获取图像，防止 API 拥堵
        frameSlider.oninput = () => {
            frameInput.value = frameSlider.value;
        };
        frameSlider.onchange = () => {
            handleFrameChange(parseInt(frameSlider.value));
        };
        
        // 数字输入框：在失焦或按回车时触发
        frameInput.onchange = () => {
            let frame = parseInt(frameInput.value);
            if (isNaN(frame) || frame < 1) {
                frame = 1;
                frameInput.value = 1;
            }
            // 关键：如果输入的数字大于滚动条最大值，自动扩展滚动条
            if (frame > parseInt(frameSlider.max)) {
                frameSlider.max = frame;
            }
            frameSlider.value = frame;
            handleFrameChange(frame);
        };


        /**
         * 1. 初始化或重置
         */
        function initializeGallery() {
            canvasWidth = parseInt(widthInput.value) || 64;
            canvasHeight = parseInt(heightInput.value) || 64;
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            // 1 像素 = 6 个十六进制数
            digitsPerFrame = canvasWidth * canvasHeight * 6;

            // 重置控件并获取第一帧
            frameInput.value = 1;
            frameSlider.value = 1;
            setControlsEnabled(true); // 启用导航控件
            handleFrameChange(1);
        }

        /**
         * 2. 跳转到随机帧
         */
        function goToRandomFrame() {
            if (isFetching) return;
            // 在当前滚动条最大范围内随机
            const maxFrame = parseInt(frameSlider.max);
            const randomFrame = Math.floor(Math.random() * maxFrame) + 1;
            
            frameInput.value = randomFrame;
            frameSlider.value = randomFrame;
            handleFrameChange(randomFrame);
        }

        /**
         * 3. 统一的帧处理函数
         */
        function handleFrameChange(frameNumber) {
            if (isFetching) return;
            currentFrame = frameNumber;
            fetchAndDrawFrame(currentFrame);
        }

        /**
         * 4. 核心功能：获取数据并绘制
         */
        async function fetchAndDrawFrame(frameNumber) {
            setLoading(true);

            // 计算我们需要从 Pi 的哪个位置开始获取数字
            // (frame 1 从 0 开始)
            const startDigitIndex = (frameNumber - 1) * digitsPerFrame;
            
            try {
                const hexPiString = await fetchPiDigits(startDigitIndex, digitsPerFrame);
                drawPixels(hexPiString);
            } catch (error) {
                console.error('获取 Pi 数据失败:', error);
                alert('获取数据失败，请检查网络或稍后再试。');
            } finally {
                setLoading(false);
            }
        }

        /**
         * 5. 辅助功能：处理 API 的分块请求
         */
        async function fetchPiDigits(startIndex, totalDigitsNeeded) {
            let allHexDigits = '';
            let digitsFetched = 0;

            while (digitsFetched < totalDigitsNeeded) {
                const digitsRemaining = totalDigitsNeeded - digitsFetched;
                const digitsToFetch = Math.min(digitsRemaining, API_MAX_DIGITS_PER_REQUEST);
                const currentStartIndex = startIndex + digitsFetched;
                
                const url = `${API_BASE_URL}?start=${currentStartIndex}&numberOfDigits=${digitsToFetch}&radix=16`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API 请求失败: ${response.statusText}`);
                }
                
                const data = await response.json();
                allHexDigits += data.content;
                digitsFetched += data.content.length;

                // 如果 API 返回的数字比请求的少（可能到了它的数据末尾）
                if (data.content.length < digitsToFetch) {
                    console.warn("API did not return all requested digits.");
                    break;
                }
            }
            return allHexDigits;
        }

        /**
         * 6. 绘制像素到 Canvas
         */
        function drawPixels(hexString) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            let piIndex = 0;
            for (let y = 0; y < canvasHeight; y++) {
                for (let x = 0; x < canvasHeight; x++) {
                    const hexColor = hexString.substring(piIndex, piIndex + 6);
                    if (hexColor.length < 6) break; // 数据不足
                    
                    ctx.fillStyle = '#' + hexColor;
                    ctx.fillRect(x, y, 1, 1);
                    piIndex += 6;
                }
            }
        }

        /**
         * 7. 更新 UI 状态 (加载中)
         */
        function setLoading(isLoading) {
            isFetching = isLoading;
            viewer.classList.toggle('loading', isLoading);
            setControlsEnabled(!isLoading); // 加载时禁用控件
        }
        
        /**
         * 8. 启用/禁用导航控件
         */
        function setControlsEnabled(enabled) {
            frameInput.disabled = !enabled;
            frameSlider.disabled = !enabled;
            randomBtn.disabled = !enabled;
        }

    </script>
</body>
</html>