<!DOCTYPE html>
<html lang="zh">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pi å†™çœŸé›†</title>
    <style>
        /* --- 1. åŸºæœ¬å’Œç§»åŠ¨ä¼˜å…ˆå¸ƒå±€ --- */
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #121212;
            color: #f0f0f0;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            padding: 1rem;
            gap: 1rem;
        }
        h1 {
            color: #4CAF50; /* Pi Green */
            font-weight: 300;
        }

        /* --- 2. æ§åˆ¶åŒºåŸŸ (è¾“å…¥å’ŒæŒ‰é’®) --- */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 0.75rem;
            width: 100%;
            max-width: 500px;
        }
        .controls label, .navigation-controls label {
            font-size: 0.9rem;
            color: #aaa;
            margin-bottom: 0.25rem;
            display: block;
        }
        .controls input, .navigation-controls input {
            width: 100%;
            padding: 0.75rem;
            font-size: 1rem;
            background-color: #2a2a2a;
            color: #fff;
            border: 1px solid #444;
            border-radius: 8px;
        }
        .controls .generate-btn {
            grid-column: 1 / -1;
            padding: 0.85rem;
            font-size: 1.1rem;
            font-weight: 600;
            background-color: #4CAF50;
            color: #121212;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .controls .generate-btn:hover {
            background-color: #5cdb60;
        }

        /* --- 3. å›¾åƒæ˜¾ç¤ºåŒºåŸŸ --- */
        .viewer {
            width: 100%;
            max-width: 500px;
            aspect-ratio: 1 / 1;
            background-color: #000;
            border-radius: 8px;
            overflow: hidden;
            position: relative;
        }
        canvas {
            width: 100%;
            height: 100%;
            image-rendering: -moz-crisp-edges;
            image-rendering: -webkit-crisp-edges;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
        }
        .loader {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 1.2rem;
            color: #fff;
            display: none; /* é»˜è®¤éšè— */
        }
        .viewer.loading canvas {
            opacity: 0.2;
        }
        .viewer.loading .loader {
            display: block;
        }

        /* --- 4. å¯¼èˆªåŒºåŸŸ (æ–°) --- */
        .navigation-controls {
            display: flex;
            flex-direction: column;
            gap: 1rem;
            width: 100%;
            max-width: 500px;
        }
        
        /* å¸§æ•°è¾“å…¥æ¡†å’ŒéšæœºæŒ‰é’® */
        .frame-input-group {
            display: flex;
            gap: 0.5rem;
        }
        .frame-input-group input[type="number"] {
            flex-grow: 1; /* å æ®ä¸»è¦ç©ºé—´ */
        }
        .frame-input-group button {
            padding: 0 1.25rem;
            font-size: 1rem;
            background-color: #333;
            color: #fff;
            border: 1px solid #555;
            border-radius: 8px;
            cursor: pointer;
        }

        /* æ»šåŠ¨æ¡æ ·å¼ */
        input[type="range"] {
            -webkit-appearance: none;
            appearance: none;
            width: 100%;
            height: 10px;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            padding: 0; /* è¦†ç›– .controls input æ ·å¼ */
        }
        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            appearance: none;
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }
        input[type="range"]::-moz-range-thumb {
            width: 24px;
            height: 24px;
            background: #4CAF50;
            border-radius: 50%;
            cursor: pointer;
        }

        /* ç¦ç”¨çŠ¶æ€ */
        input:disabled, button:disabled {
            background: #222;
            color: #666;
            cursor: not-allowed;
            border-color: #444;
        }
        input[type="range"]:disabled::-webkit-slider-thumb {
            background: #666;
        }
        input[type="range"]:disabled::-moz-range-thumb {
            background: #666;
        }

    </style>
</head>
<body>

    <h1>Pi å†™çœŸé›† ğŸ“·</h1>

    <div class="controls">
        <div>
            <label for="widthInput">å®½åº¦ (Width)</label>
            <input id="widthInput" type="number" value="64">
        </div>
        <div>
            <label for="heightInput">é«˜åº¦ (Height)</label>
            <input id="heightInput" type="number" value="64">
        </div>
        <button id="generateBtn" class="generate-btn">ç”Ÿæˆ / é‡ç½®</button>
    </div>

    <div id="viewer" class="viewer">
        <canvas id="piCanvas"></canvas>
        <div id="loader" class="loader">åŠ è½½ä¸­...</div>
    </div>

    <div class="navigation-controls">
        <div>
            <label for="frameInput">å¸§ (Frame)</label>
            <div class="frame-input-group">
                <input id="frameInput" type="number" min="1" value="1" disabled>
                <button id="randomBtn" disabled>éšæœº</button>
            </div>
        </div>
        <div>
            <label for="frameSlider">æ»šåŠ¨æ¡ (Slider)</label>
            <input id="frameSlider" type="range" min="1" max="10000" value="1" disabled>
        </div>
    </div>

    <script>
        // --- DOM å…ƒç´  ---
        const widthInput = document.getElementById('widthInput');
        const heightInput = document.getElementById('heightInput');
        const generateBtn = document.getElementById('generateBtn');
        const frameInput = document.getElementById('frameInput');
        const randomBtn = document.getElementById('randomBtn');
        const frameSlider = document.getElementById('frameSlider');
        const canvas = document.getElementById('piCanvas');
        const ctx = canvas.getContext('2d');
        const viewer = document.getElementById('viewer');

        // --- çŠ¶æ€å˜é‡ ---
        let currentFrame = 1;
        let canvasWidth = 0;
        let canvasHeight = 0;
        let digitsPerFrame = 0;
        let isFetching = false;
        
        // --- API è®¾ç½® ---
        const API_BASE_URL = 'https://api.pi.delivery/v1/pi';
        const API_MAX_DIGITS_PER_REQUEST = 50000;

        // --- äº‹ä»¶ç›‘å¬ ---
        generateBtn.onclick = initializeGallery;
        randomBtn.onclick = goToRandomFrame;

        // æ»šåŠ¨æ¡ï¼šoninput åœ¨æ‹–åŠ¨æ—¶è§¦å‘ï¼Œonchange åœ¨é‡Šæ”¾æ—¶è§¦å‘
        // æˆ‘ä»¬åœ¨æ‹–åŠ¨æ—¶æ›´æ–°æ•°å­—æ¡†ï¼Œåœ¨é‡Šæ”¾æ—¶æ‰è·å–å›¾åƒï¼Œé˜²æ­¢ API æ‹¥å µ
        frameSlider.oninput = () => {
            frameInput.value = frameSlider.value;
        };
        frameSlider.onchange = () => {
            handleFrameChange(parseInt(frameSlider.value));
        };
        
        // æ•°å­—è¾“å…¥æ¡†ï¼šåœ¨å¤±ç„¦æˆ–æŒ‰å›è½¦æ—¶è§¦å‘
        frameInput.onchange = () => {
            let frame = parseInt(frameInput.value);
            if (isNaN(frame) || frame < 1) {
                frame = 1;
                frameInput.value = 1;
            }
            // å…³é”®ï¼šå¦‚æœè¾“å…¥çš„æ•°å­—å¤§äºæ»šåŠ¨æ¡æœ€å¤§å€¼ï¼Œè‡ªåŠ¨æ‰©å±•æ»šåŠ¨æ¡
            if (frame > parseInt(frameSlider.max)) {
                frameSlider.max = frame;
            }
            frameSlider.value = frame;
            handleFrameChange(frame);
        };


        /**
         * 1. åˆå§‹åŒ–æˆ–é‡ç½®
         */
        function initializeGallery() {
            canvasWidth = parseInt(widthInput.value) || 64;
            canvasHeight = parseInt(heightInput.value) || 64;
            
            canvas.width = canvasWidth;
            canvas.height = canvasHeight;

            // 1 åƒç´  = 6 ä¸ªåå…­è¿›åˆ¶æ•°
            digitsPerFrame = canvasWidth * canvasHeight * 6;

            // é‡ç½®æ§ä»¶å¹¶è·å–ç¬¬ä¸€å¸§
            frameInput.value = 1;
            frameSlider.value = 1;
            setControlsEnabled(true); // å¯ç”¨å¯¼èˆªæ§ä»¶
            handleFrameChange(1);
        }

        /**
         * 2. è·³è½¬åˆ°éšæœºå¸§
         */
        function goToRandomFrame() {
            if (isFetching) return;
            // åœ¨å½“å‰æ»šåŠ¨æ¡æœ€å¤§èŒƒå›´å†…éšæœº
            const maxFrame = parseInt(frameSlider.max);
            const randomFrame = Math.floor(Math.random() * maxFrame) + 1;
            
            frameInput.value = randomFrame;
            frameSlider.value = randomFrame;
            handleFrameChange(randomFrame);
        }

        /**
         * 3. ç»Ÿä¸€çš„å¸§å¤„ç†å‡½æ•°
         */
        function handleFrameChange(frameNumber) {
            if (isFetching) return;
            currentFrame = frameNumber;
            fetchAndDrawFrame(currentFrame);
        }

        /**
         * 4. æ ¸å¿ƒåŠŸèƒ½ï¼šè·å–æ•°æ®å¹¶ç»˜åˆ¶
         */
        async function fetchAndDrawFrame(frameNumber) {
            setLoading(true);

            // è®¡ç®—æˆ‘ä»¬éœ€è¦ä» Pi çš„å“ªä¸ªä½ç½®å¼€å§‹è·å–æ•°å­—
            // (frame 1 ä» 0 å¼€å§‹)
            const startDigitIndex = (frameNumber - 1) * digitsPerFrame;
            
            try {
                const hexPiString = await fetchPiDigits(startDigitIndex, digitsPerFrame);
                drawPixels(hexPiString);
            } catch (error) {
                console.error('è·å– Pi æ•°æ®å¤±è´¥:', error);
                alert('è·å–æ•°æ®å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–ç¨åå†è¯•ã€‚');
            } finally {
                setLoading(false);
            }
        }

        /**
         * 5. è¾…åŠ©åŠŸèƒ½ï¼šå¤„ç† API çš„åˆ†å—è¯·æ±‚
         */
        async function fetchPiDigits(startIndex, totalDigitsNeeded) {
            let allHexDigits = '';
            let digitsFetched = 0;

            while (digitsFetched < totalDigitsNeeded) {
                const digitsRemaining = totalDigitsNeeded - digitsFetched;
                const digitsToFetch = Math.min(digitsRemaining, API_MAX_DIGITS_PER_REQUEST);
                const currentStartIndex = startIndex + digitsFetched;
                
                const url = `${API_BASE_URL}?start=${currentStartIndex}&numberOfDigits=${digitsToFetch}&radix=16`;
                
                const response = await fetch(url);
                if (!response.ok) {
                    throw new Error(`API è¯·æ±‚å¤±è´¥: ${response.statusText}`);
                }
                
                const data = await response.json();
                allHexDigits += data.content;
                digitsFetched += data.content.length;

                // å¦‚æœ API è¿”å›çš„æ•°å­—æ¯”è¯·æ±‚çš„å°‘ï¼ˆå¯èƒ½åˆ°äº†å®ƒçš„æ•°æ®æœ«å°¾ï¼‰
                if (data.content.length < digitsToFetch) {
                    console.warn("API did not return all requested digits.");
                    break;
                }
            }
            return allHexDigits;
        }

        /**
         * 6. ç»˜åˆ¶åƒç´ åˆ° Canvas
         */
        function drawPixels(hexString) {
            ctx.fillStyle = '#000';
            ctx.fillRect(0, 0, canvasWidth, canvasHeight);
            
            let piIndex = 0;
            for (let y = 0; y < canvasHeight; y++) {
                for (let x = 0; x < canvasHeight; x++) {
                    const hexColor = hexString.substring(piIndex, piIndex + 6);
                    if (hexColor.length < 6) break; // æ•°æ®ä¸è¶³
                    
                    ctx.fillStyle = '#' + hexColor;
                    ctx.fillRect(x, y, 1, 1);
                    piIndex += 6;
                }
            }
        }

        /**
         * 7. æ›´æ–° UI çŠ¶æ€ (åŠ è½½ä¸­)
         */
        function setLoading(isLoading) {
            isFetching = isLoading;
            viewer.classList.toggle('loading', isLoading);
            setControlsEnabled(!isLoading); // åŠ è½½æ—¶ç¦ç”¨æ§ä»¶
        }
        
        /**
         * 8. å¯ç”¨/ç¦ç”¨å¯¼èˆªæ§ä»¶
         */
        function setControlsEnabled(enabled) {
            frameInput.disabled = !enabled;
            frameSlider.disabled = !enabled;
            randomBtn.disabled = !enabled;
        }

    </script>
</body>
</html>